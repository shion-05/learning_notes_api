<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Learning Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; margin: 16px; }
    #tags button { margin: 4px; }
    .entry { border: 1px solid #ddd; padding: 8px; margin: 8px 0; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Learning Notes</h1>

  <!--æ¤œç´¢ãƒãƒ¼ -->
  <section>
    <input id="keyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆä¾‹: FastAPI / æ©Ÿæ¢°å­¦ç¿’ï¼‰" />
    <button id="searchBtn">æ¤œç´¢</button>
  </section>

  <!--ã‚¿ã‚°ä¸€è¦§ -->
  <section>
    <h3>ã‚¿ã‚°</h3>
    <div id="tags"></div>
  </section>

  <!--æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <section>
    <h3>æ–°è¦è¿½åŠ </h3>
    <form id="createForm">
      <div><input name="term" placeholder="ç”¨èªãƒ»ãƒˆãƒ”ãƒƒã‚¯å" required /></div>
      <div><input name="short_description" placeholder="çŸ­ã„èª¬æ˜" required /></div>
      <div><textarea name="detail" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰"></textarea></div>
      <div><input name="tags" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ ä¾‹: AI,Python" /></div>
      <div><input name="source" placeholder="å‡ºå…¸URLãªã©ï¼ˆä»»æ„ï¼‰" /></div>
      <button type="submit">è¿½åŠ </button>
    </form>
  </section>

  <!-- ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <section>
    <h3>ä¸€è¦§</h3>
    <div id="entries"></div>
  </section>

  <script>
    //APIã®ãƒ™ãƒ¼ã‚¹URLï¼ˆåŒã˜FastAPIã‚µãƒ¼ãƒãƒ¼å†…ãªã‚‰ç©ºæ–‡å­—ã§OKï¼‰
    const API = "";

    // å…±é€šã®JSONå–å¾—é–¢æ•°ï¼ˆfetchã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
    async function fetchJSON(path) {
      const res = await fetch(API + path);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    //ãƒãƒ¼ãƒˆä¸€è¦§ã®æç”»
    function renderEntries(items) {
      const box = document.getElementById("entries");
      box.innerHTML = ""; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
      if (!items.length) {
        box.textContent = "ãƒ‡ãƒ¼ã‚¿ãªã—";
        return;
      }

      for (const e of items) {
        const div = document.createElement("div");
        div.className = "entry";

        // ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã®HTMLæ§‹æˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <b>${e.term}</b><br>
              <span>${e.short_description}</span><br>
              <small style="color:#666;">${(e.tags || []).join(", ")}</small>
            </div>
            <!-- ğŸ—‘ å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            <button data-id="${e.id}" class="deleteBtn"
              style="background:#ff5555; color:white; border:none; border-radius:6px; padding:4px 8px; cursor:pointer;">
              å‰Šé™¤
            </button>
          </div>
        `;

        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        const btn = div.querySelector(".deleteBtn");
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm(`ID ${id} ã®ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

          // DELETEãƒ¡ã‚½ãƒƒãƒ‰ã§APIå‘¼ã³å‡ºã—
          const res = await fetch(`/entries/${id}`, { method: "DELETE" });
          if (!res.ok) {
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
            console.error(await res.text());
            return;
          }

          // å‰Šé™¤å¾Œã«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          await loadAll();
        });

        box.appendChild(div);
      }
    }

    //ã‚¿ã‚°ä¸€è¦§ã®èª­ã¿è¾¼ã¿
    async function loadTags() {
      const tags = await fetchJSON("/tags");
      const box = document.getElementById("tags");
      box.innerHTML = "";
      for (const t of tags) {
        const btn = document.createElement("button");
        btn.textContent = `${t.name} (${t.count})`;
        btn.onclick = async () => {
          const items = await fetchJSON(`/entries?tag=${encodeURIComponent(t.name)}`);
          renderEntries(items);
        };
        box.appendChild(btn);
      }
    }

    //ä¸€è¦§ï¼‹ã‚¿ã‚°ã‚’ã¾ã¨ã‚ã¦å†èª­ã¿è¾¼ã¿
    async function loadAll() {
      await loadTags();
      const items = await fetchJSON("/entries");
      renderEntries(items);
    }

    //æ¤œç´¢ãƒœã‚¿ãƒ³ã®å‡¦ç†
    document.getElementById("searchBtn").onclick = async () => {
      const kw = document.getElementById("keyword").value.trim();
      if (!kw) {
        renderEntries(await fetchJSON("/entries"));
        return;
      }
      const items = await fetchJSON(`/entries/search?keyword=${encodeURIComponent(kw)}`);
      renderEntries(items);
    };

    // â• æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
    document.getElementById("createForm").onsubmit = async (ev) => {
      ev.preventDefault(); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é˜²æ­¢
      const fd = new FormData(ev.target);
      const payload = {
        term: fd.get("term"),
        short_description: fd.get("short_description"),
        detail: fd.get("detail") || null,
        tags: (fd.get("tags") || "").split(",").map(s => s.trim()).filter(Boolean),
        source: fd.get("source") || null
      };

      const res = await fetch("/entries", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        alert(await res.text());
        return;
      }

      ev.target.reset(); // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      await loadAll();   // ä¸€è¦§ã¨ã‚¿ã‚°ã‚’æ›´æ–°
    };

    //ãƒšãƒ¼ã‚¸åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«ä¸€è¦§ã¨ã‚¿ã‚°ã‚’å–å¾—
    loadAll();
  </script>
</body>
</html>
